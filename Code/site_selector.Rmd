---
title: "site-selector"
author: "Molly Bell"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# set working dir
knitr::opts_knit$set(root.dir = here::here())
   # sets the working directory to where the project file is 
```

```{r}
# load required packages
package.list <- c('plotly',
                  'dplyr',
                  'tidyr',
                  'ggplot2',
                  'gridExtra',
                  'GGally'
)
packageLoad <- function(packages){
  for (i in packages) {
    if (!require(i, character.only = TRUE)) {
      install.packages(i)
      library(i, character.only = TRUE)
    }
  }
}
packageLoad(package.list)
```

```{r}
# Uploading file-merge code to create data frame
source('./Code/file-merger.R')
# create data frame
dat <- returnAllFiles(d = directory, export = FALSE)
# make columns lowercase so they are all the same case
colnames(dat) <- tolower(names(dat))
```

```{r, include=FALSE}
# Site list
  # To select site, un-comment your location of interest (alphabetical order)
  # This list may need to be updated as more sites are added/removed
# loc = 'ARDEC 2200'
loc = 'AVRC STAR'
# loc = 'Barley'
# loc = 'Berthoud'
# loc = 'Big Hollow'
# loc = 'Boulder Lake'
# loc = 'Below Stagecoach Dam'
# loc = 'Gunnison'
# loc = 'Kerbel'
# loc = 'Legacy'
# loc = 'Molina'
# loc = 'Morrison Creek'
# loc = 'Stage Coach Above'
# loc = 'Stage Coach In'
# loc = 'Stagecoach'
# loc = 'The Ranch'
# loc = 'Upper Yampa'
# loc = 'Yellow Jacket'
```

```{r}
# function to save site data as csv
csv_data <- function(dat, location_name) {
  location_data <- dat %>%
    filter(location.name == location_name)
  #create output folder
  folder_name <- "site_selector_temporary_results"
  if (!file.exists(folder_name)) {
    dir.create(folder_name)
  }
  
  file_name <- paste0(folder_name, "/", location_name, "_data_", format(Sys.Date(), "%Y-%m-%d"), ".csv")
  write.csv(location_data, file = file_name, row.names = FALSE)
}
# use the function to save
csv_data(dat, loc)
```

```{r}

# plotly plot with dropdown
create_violin_plot <- function(df, selected_location) {
  y_axis_var_names <- unique(df$analyte)
  
   event_colors <- c("Inflow" = "#E69F00", "Outflow" = "#56B4E9", "Point Sample" = "#009E73")
  
  create_buttons <- function(df, y_axis_var_name, selected_location) {
    list(
      method = 'restyle',
      args = list('y', list(df[df$analyte == y_axis_var_name & df$location.name == selected_location, "result"])),
      label = sprintf('Show %s', y_axis_var_name)
    )
  }
  
  location_violin_plot <- plot_ly(df, x = ~event.type,
                                  y = ~result,
                                  color = ~event.type,
                                  colors = event_colors,
                                  type = 'violin', box = list(
                                    visible = T
                                  ),
                                  meanline = list(
                                    visible = T
                                  )) %>%
    layout(
      title = paste("Violin plots for Location:", selected_location),
      xaxis = list(title = "Collected", tickformat = "%y-%m-%d"),
      yaxis = list(title = "Result"),
      showlegend = TRUE,
      updatemenus = list(
        list(
          buttons = lapply(y_axis_var_names, create_buttons, df = df, selected_location = selected_location)
        )
      ))
  
  return(location_violin_plot)
}
create_violin_plot(dat, loc)

```


```{r}


create_scatterplot_matrix <- function(data, location_name) {
  
  filtered_data <- data %>%
    filter(location.name == location_name) %>%
   mutate(sample.id = sub("-[1-5]$", "", sample.id),  # Remove "-1", "-2", "-3", "-4", "-5" from sample.id
                  sample.id = sub("-[1-5]-D$", "-D", sample.id)) %>%  # Replace "-1-D", "-2-D", "-3-D", "-4-D", "-5-D" with "-D"
    select(sample.id, result, analyte, event.type)
  
  # Pivot the data wider
  pivoted_data <- filtered_data %>%
    tidyr::pivot_wider(names_from = analyte, values_from = result)
  
  if (nrow(pivoted_data) == 0) {
    warning("No data available for the given location.")
    return(NULL)
  }
  
  # Remove rows with NA values in specific analyte columns before creating scatterplot matrix
  analyte_columns <- colnames(pivoted_data)[-c(1, 2)]  # Exclude the first two columns (sample.id and event.type)

  # Create scatterplot matrix using pairs()
  pairs(pivoted_data[, analyte_columns],
        labels = analyte_columns,
        col = as.numeric(factor(pivoted_data$event.type)),
        pch = 19)
  
  return(NULL)
}



create_scatterplot_matrix(dat, loc)





```

