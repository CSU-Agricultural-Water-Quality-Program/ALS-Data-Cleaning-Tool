---
title: "Site selector data visualization tool"
author: "Molly Bell and A.J. Brown using R version 4.2.2"
date: "`r Sys.Date()`"
output: 
  html_document:
    output_dir: "site_selector_temporary_results"
---
The following is an interactive data report containing water quality data from 
samples taken by the Colorado State University (CSU) Agriculture Water Quality 
Program (AWQP) at a location selected by the user when running the script
(reported below). For more information, please contact A.J. Brown at
Ansley.Brown@colostate.edu or visit the CSU AWQP Website at 
https://waterquality.colostate.edu.

## Special Notes

*	All “0” values reported are non-detects (ND) reported by ALS
*	Total suspended solids (TSS), Electrical Conductivity (EC), and pH are performed by AWQP staff at CSU, whereas all other analytes are reported by ALS Laboratories
*	Methods used to derive each analyte can be found in the Raw Data table in the “method” column

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# set working dir
knitr::opts_knit$set(root.dir = here::here())
   # sets the working directory to where the project file is 
```

```{r, include=FALSE}
# load required packages
package.list <- c('plotly',
                  'dplyr',
                  'tidyr',
                  'DT'
                  # 'ggplot2',
                  # 'gridExtra',
                  # 'GGally',
                  # 'PerformanceAnalytics'
                  )
packageLoad <- function(packages){
  for (i in packages) {
    if (!require(i, character.only = TRUE)) {
      install.packages(i)
      library(i, character.only = TRUE)
    }
  }
}
packageLoad(package.list)
```

```{r, include=FALSE}
# Uploading file-merge code to create data frame
source('./Code/file-merger.R')
# create data frame
dat <- returnAllFiles(d = directory, export = FALSE)
# make columns lowercase so they are all the same case
colnames(dat) <- tolower(names(dat))
```

```{r, include=FALSE}
# Site list
  # To select site, un-comment your location of interest (alphabetical order)
  # This list may need to be updated as more sites are added/removed
# loc = 'ARDEC 2200'
loc = 'AVRC STAR'
# loc = 'Barley'
# loc = 'Berthoud'
# loc = 'Big Hollow'
# loc = 'Boulder Lake'
# loc = 'Below Stagecoach Dam'
# loc = 'Gunnison'
# loc = 'Kerbel'
# loc = 'Legacy'
# loc = 'Molina'
# loc = 'Morrison Creek'
# loc = 'Stage Coach Above'
# loc = 'Stage Coach In'
# loc = 'Stagecoach'
# loc = 'The Ranch'
# loc = 'Upper Yampa'
# loc = 'Yellow Jacket'
```

## Location Selected: <span style="color:#4CAF50">`r loc`.</span>

```{r, include=FALSE}
# function to save site data as csv
csv_data <- function(dat, location_name) {
  location_data <- dat %>%
    filter(location.name == location_name)
  #create output folder
  folder_name <- "site_selector_temporary_results"
  if (!file.exists(folder_name)) {
    dir.create(folder_name)
  }
  
  file_name <- paste0(folder_name, "/", location_name, "_data_", format(Sys.Date(), "%Y-%m-%d"), ".csv")
  write.csv(location_data, file = file_name, row.names = FALSE)
  return(file_name)
}
# use the function to save
file = csv_data(dat, loc)
```

### CSV Export of selected site data saved as: 
`r file`

## Interactive Violin Plot
Use the below boxplot to graph various water analytes stratified by sample type
(i.e., Inflow, Outflow, etc.). Analytes can be selected by using the dropdown 
menu on the top left of the graph. Hover over points with your mouse for
additional information.

*To save your plot for use elsewhere:* hover over the top right corner and click
the camera icon.  The PNG will be saved in your downloads folder.

```{r, warning=FALSE}

# plotly Violin plot with dropdown
create_violin_plot <- function(df, selected_location) {
  y_axis_var_names <- unique(df$analyte)
  
   event_colors <- c("Inflow" = "#E69F00", "Outflow" = "#56B4E9", "Point Sample" = "#009E73")
  
  create_buttons <- function(df, y_axis_var_name, selected_location) {
    list(
      method = 'restyle',
      args = list('y', list(df[df$analyte == y_axis_var_name & df$location.name == selected_location, "result"])),
      label = sprintf('Show %s', y_axis_var_name)
    )
  }
  
  location_violin_plot <- plot_ly(df, x = ~event.type,
                                  y = ~result,
                                  color = ~event.type,
                                  colors = event_colors,
                                  type = 'violin', box = list(
                                    visible = T
                                  ),
                                  meanline = list(
                                    visible = T
                                  )) %>%
    # Adding scatter points next to violin bars
    add_trace(x = ~event.type, y = ~result, type = 'scatter', mode = 'markers', marker = list(size = 3, opacity = 0.6), 
              color = ~event.type, colors = event_colors, showlegend = FALSE, hoverinfo = 'y+text', 
              text = ~paste("Result: ", result, "<br>Event Type: ", event.type)) %>%
    
    layout(
      title = paste("Violin plots for Location:", selected_location),
      xaxis = list(title = "Collected", tickformat = "%y-%m-%d"),
      yaxis = list(title = "Result"),
      showlegend = TRUE,
      updatemenus = list(
        list(
          buttons = lapply(y_axis_var_names, create_buttons, df = df, selected_location = selected_location)
        )
      ))
  
  return(location_violin_plot)
}
create_violin_plot(dat, loc)

```

## Scatterplot Matrix of All Numerical Analyte Data
Use the below scatter matrix to look at potential relationships between
numerical variables. Please note that all analytes are reported in mg/L EXCEPT
selenium (Se), which is reported in ug/L.

```{r, warning=FALSE}
create_scatterplot_matrix <- function(data, location_name) {
  
  filtered_data <- data %>%
    filter(location.name == location_name) %>%
   mutate(sample.id = sub("-[1-5]$", "", sample.id),  # Remove "-1", "-2", "-3", "-4", "-5" from sample.id
                  sample.id = sub("-[1-5]-D$", "-D", sample.id)) %>%  # Replace "-1-D", "-2-D", "-3-D", "-4-D", "-5-D" with "-D"
    select(sample.id, result, analyte, event.type)
  
  # Pivot the data wider
  pivoted_data <- filtered_data %>%
    tidyr::pivot_wider(names_from = analyte, values_from = result)
  
  if (nrow(pivoted_data) == 0) {
    warning("No data available for the given location.")
    return(NULL)
  }
  
  # drop non-numeric columns
  pd2 <- subset(pivoted_data, select = -c(sample.id, event.type))
  
  # create scatter plot matrix using base r
  pairs(pd2,
        col = 'blue',
        pch = 8,
        main = 'Scatterplot Matrix of All Water Analytes'
        )
  
  # TODO: create scatter matrix using PerformanceAnalytics package
  # chart.Correlation(pd2,
  #                 histogram = T,
  #                 method = 'pearson',
  #                 pch = 8
  #                 )
}

create_scatterplot_matrix(dat, loc)
```
# Raw Data
Use the table below to look at raw values.
```{r}
datatable(dat, colnames = c('Sample ID', 'Lab ID', 'Method', 'CAS Number', 'Analyte', 'Result', 'Units', 'Dilution', "Results Reported To", 'MDL', 'RL', 'Report Basis', 'Moisture (%)', 'Solid (%)', 'Non detect', 'Duplicate', 'Location', 'Treatment', 'Method Name', 'Event Type', 'Lab ID', 'Matrix', 'Collection Date', 'Recieved Date', 'Hold Time', 'Flag'))
```
